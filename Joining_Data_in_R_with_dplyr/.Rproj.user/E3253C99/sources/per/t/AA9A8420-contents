---
title: "Joining Data in R with dplyr"
author: "Jeff Li"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_depth: 3
    toc_float: true
---

Instructor: Garrett Grolemund  (Data Scientist at RStudion)

Abstract: 

In this course, Garrett teaches how to combine data sets with *dplyr*. 




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## (I) Load Required Libraries
```{r, message = FALSE}
library(dplyr)
library(tidyverse)

```

# 1. Mutating joins

* `left_joint()`: the basic join function in *dplyr*

* `right_joint()`: 

* `inner_joint()`

* `full_joint()`


Note: left_joint(x, y, by = "name") equals to right_joint(y, x, by = "name")

check a dataset (A) is equal to a dataset (B): 

* `setequal(A, B)`


```{r}
# (a) create a dataframe of songs

songs <- tibble(song = c("Come Together", "Dream On", "Hello, Goodbye", "It's Not Unusual"), 
                album = c("Abbey Road", "Aerosmith", "Magical Mystery Tour", "Along Came Jonnes"), 
                first = c("John", "Steven", "Paul", "Tom"), 
                last = c("Lennon", "Tyler", "McCartney", "Jones"))

# (b) Create the dataframe of artists
artists <- tribble(~first, ~last, ~instrument,
                    "Jimmy",   "Buffett",  "Guitar",    
                    "George", "Harrison ",  "Guitar",    
                    "Mick  ", "Jagger",  "Vocals",    
                    "Tom   ", "Jones",  "Vocals",    
                    "Davy  ", "Jones",  "Vocals",    
                    "John  ", "Lennon",  "Guitar",    
                    "Paul  ", "McCartney",  "Bass  ",    
                    "Jimmy ", "Page",  "Guitar",    
                    "Joe   ", "Perry",  "Guitar",    
                    "Elvis ", "Presley  ",  "Vocals",    
                    "Keith ", "Richards ",  "Guitar",    
                    "Paul  ", "Simon    ",  "Guitar",    
                    "Ringo ", "Starr    ",  "Drums ",    
                    "Joe   ", "Walsh    ",  "Guitar",    
                    "Brian ", "Wilson   ",  "Vocals",    
                    "Nancy ", "Wilson   ",  "Vocals") 

# removing whitespace
artists <- data.frame(lapply(artists, trimws), stringsAsFactors = FALSE)


# (c) create albums 
albums <- tribble(~album, ~band, ~year, 
                  "A Hard Day's Night       ",  "The Beatles       ",   1964,
                  "Magical Mystery Tour     ",  "The Beatles       ",   1967,
                  "Beggar's Banquet         ",  "The Rolling Stones",   1968,
                  "Abbey Road               ",  "The Beatles       ",   1969,
                  "Led Zeppelin IV          ",  "Led Zeppelin      ",   1971,
                  "The Dark Side of the Moon",  "Pink Floyd        ",   1973,
                  "Aerosmith                ",  "Aerosmith         ",   1973,
                  "Rumours                  ",  "Fleetwood Mac     ",   1977,
                  "Hotel California         ",  "Eagles            ",   1982) 

# remove whitespace
albums <- data.frame(lapply(albums, trimws), stringsAsFactors = FALSE)

# (d) Create "bands"
bands <- tribble(~first, ~last, ~band, 
                  "John     ",  "Bonham   ", "Led Zeppelin      ",
                  "John Paul",  "Jones    ", "Led Zeppelin      ",
                  "Jimmy    ",  "Page     ", "Led Zeppelin      ",
                  "Robert   ",  "Plant    ", "Led Zeppelin      ",
                  "George   ",  "Harrison ", "The Beatles       ",
                  "John     ",  "Lennon   ", "The Beatles       ",
                  "Paul     ",  "McCartney", "The Beatles       ",
                  "Ringo    ",  "Starr    ", "The Beatles       ",
                  "Jimmy    ",  "Buffett  ", "The Coral Reefers ",
                  "Mick     ",  "Jagger   ", "The Rolling Stones",
                  "Keith    ",  "Richards ", "The Rolling Stones",
                  "Charlie  ",  "Watts    ", "The Rolling Stones",
                  "Ronnie   ",  "Wood     ", "The Rolling Stones")

# remove whitespace
bands <- data.frame(lapply(bands, trimws), stringsAsFactors = FALSE)

```


## 1.1 Basic join
```{r}
bands %>%
  left_join(artists, by = c("first", "last"))


songs %>%
  inner_join(albums, by = "album")


artists %>%
  full_join(bands, by = c("first", "last"))


# "Mutating" joins combine variables from the LHS and RHS
band_members %>% inner_join(band_instruments, by = "name")
band_members %>% left_join(band_instruments, by = "name")
band_members %>% right_join(band_instruments, by = "name")
band_members %>% full_join(band_instruments, by = "name")

# Use a named `by` if the join variables have different names
band_members %>% full_join(band_instruments2, by = c("name" = "artist"))

```


# 2. Filtering joins and set operations

## 2.1 Filtering joins 

* `semi_joint()`: A concise way to filter data from the first dataset based on information in a second dataset. Return all rows from x where there are matching values in y, keeping just columns from x.

* `anti_join()`: use an anti-join to see which rows will not be matched to a second dataset by a join. return all rows from x where there are not matching values in y, keeping just columns from x.

```{r}
# find artists with songs
artists %>%
  semi_join(songs, by = c("first", "last"))

albums %>% 
  # Collect the albums made by a band
  semi_join(bands, by = "band") %>% 
  # Count the albums made by a band
  nrow()

# Return rows of artists that don't have bands info
artists %>% 
  anti_join(bands, by = c("first", "last"))


# "Filtering" joins keep cases from the LHS
band_members %>% semi_join(band_instruments, by = "name")
band_members %>% anti_join(band_instruments, by = "name")



```

## 2.2 Set operations

These functions override the set functions provided in base to make them generic so that efficient versions for data frames and other tables can be provided. The default methods call the base versions. Beware that intersect(), union() and setdiff() remove duplicates.


* `union()`: combine two datasets without duplicating any values. It will remove duplicate rows. 

* `intersect()`: very much like `semi_join()* if datasets contain the exact same variables

* `setdiff()`: 

* `setequal(x, y)` 


```{r}
# (a) Create two test data sets
mtcars_new <- mtcars %>%
    rownames_to_column(var = "model") 


first <- mtcars_new[1:20, ]
second <- mtcars_new[10:32, ]

# (b) return 10:20 
intersect(first, second)

# (c) return 1:32  (remove duplicates)
union(first, second)

# (d) return first 1:9 
setdiff(first, second)

# (e) return 21:32
setdiff(second, first)

# keep duplicates (does not remove duplicates)
union_all(first, second) 

union_all(first, second) %>%
  filter(model == "Merc 280")

setequal(mtcars, mtcars[32:1, ])
```



# 3. Assembling data

## 3.1 `bind_rows()`

```{r}
# list files inside a zip file 
master <- as.character(unzip("data/jimi_hendrix.zip", list = TRUE)$Name)

# read files from the zip files
discography <- read_csv(unz("data/jimi_hendrix.zip", master[2]))

jimi <- list(`Are You Experienced` = read_csv(unz("data/jimi_hendrix.zip",  master[3])), 
                 `Axis: Bold As Love` = read_csv(unz("data/jimi_hendrix.zip",  master[4])),
                 `Electric Ladyland` = read_csv(unz("data/jimi_hendrix.zip",  master[5])))
 
jimi %>% 
  # Bind jimi into a single data frame
  bind_rows(.id = "album") %>% 
  # Make a complete data frame
  left_join(discography, by = "album")
 
```

## 3.2 `bind_cols()`

```{r}
# list files inside a zip file 
master <- as.character(unzip("data/hank_williams.zip", list = TRUE)$Name)

# read files from the zip files without unzip
hank_charts <- read_csv(unzip("data/hank_williams.zip", master[1]))
hank_years <- read_csv(unzip("data/hank_williams.zip", master[2]))


# bind columns

hank_years %>% 
  # Reorder hank_years alphabetically by song title
  arrange(song) %>% 
  # Select just the year column
  select(year) %>% 
  # Bind the year column
  bind_cols(hank_charts) %>% 
  # Arrange the finished dataset
  arrange(year, song)
```

If two datasets whose rows do not align, it is meaningless data if we bind them together. 


## 3.3 data_frame(), as_data_frame()

```{r}
# create three vectors for the following excericises
hank_year <- hank_years$year
hank_song <- hank_years$song
hank_peak <- hank_charts$peak


# Make combined data frame using data_frame()
data_frame(year = hank_year, 
           song = hank_song, 
           peak = hank_peak ) %>% 
  # Extract songs where peak equals 1
  filter(peak == 1)
```



# 4. Advanced joining


## 4.1 No Keys

```{r}
library(tibble)

# add row names as a column 
rownames(mtcars)

df1 <- mtcars %>%
  rownames_to_column(var = "model") %>%
  select(model, mpg)

# create a new data frame
df2 <- mtcars[, 4:5]

# create a key for df2, then left join with df1
df2 %>%
  rownames_to_column(var = "model")  %>%
  left_join(df1, by = "model")


```

## 4.2 Non-unique keys 

```{r}

df_my <- mtcars %>%
  rownames_to_column(var = "model") 

df1 <- df_my %>% select(model:disp) %>% head(n = 5)

df2 <- df_my %>% select(model, vs) %>% head(n = 5) 

df3 <- union_all(df2[1:3, ], df2[2:5, ]) %>% arrange(model)

# note df3 has non-uniqe keys

# left_join() duplicates the row once for everry match 
df1 %>% 
  left_join(df3, by = "model")


```


## 4.3 Joining multiple tables

the *purrr* package helps to apply R functions to data in efficient ways. 


*ruduce()*:   reduce a list to a single value by iteratively applying a binary funtion

```{r}

1:3 %>% reduce(`+`)

1:10 %>% reduce(`*`)

paste2 <- function(x, y, sep = ".") str_c(x, y, sep = sep)

letters[1:4] %>% reduce(paste2)

letters[1:4] %>% reduce2(c("-", ".", "-"), paste2)


samples <- rerun(2, sample(10, 5))
samples

reduce(samples, union)

reduce(samples, union_all)

reduce(samples, intersect)

x <- list(c(0,1), c(2,3), c(4,5))

x %>% reduce(c)

x %>% reduce_right(c)

```



# 5. Case study 


## 5.1 Lahman's Baseball Database

```{r}
#install.packages("Lahman")
library(Lahman)

d <- data.frame(data(package = "Lahman")$results) 
d$Item <- as.character(d$Item)


dataStr <- function(package="Lahman", ...)
  {
  d <- data(package=package, envir=new.env(), ...)$results[,"Item"]
  d <- sapply(strsplit(d, split=" ", fixed=TRUE), "[", 1)
  d <- d[order(tolower(d))]
  for(x in d){ message(x, ":  ", class(get(x))); message(str(get(x)))}
}

dataStr()
```

