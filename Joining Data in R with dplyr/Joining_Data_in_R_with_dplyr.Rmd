---
title: "Joining Data in R with dplyr"
author: "Jeff Li"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_depth: 3
    toc_float: true
---

Instructor: Garrett Grolemund  (Data Scientist at RStudion)

Abstract: 

In this course, Garrett teaches how to combine data sets with *dplyr*. 




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## (I) Load Required Libraries
```{r, message = FALSE}
library(dplyr)
library(tidyverse)

```

# 1. Mutating joins

* `left_join()`: the basic join function in *dplyr*

* `rignt_joint()`: 

* `inner_joint()`

* `full_jont()`


Note: left_joint(x, y, by = "name") equals to right_joint(y, x, by = "name")

check a dataset (A) is equal to a dataset (B): 

* `setequal(A, B)`


```{r}
# (a) create a dataframe of songs

songs <- tibble(song = c("Come Together", "Dream On", "Hello, Goodbye", "It's Not Unusual"), 
                album = c("Abbey Road", "Aerosmith", "Magical Mystery Tour", "Along Came Jonnes"), 
                first = c("John", "Steven", "Paul", "Tom"), 
                last = c("Lennon", "Tyler", "McCartney", "Jones"))

# (b) Create the dataframe of artists
artists <- tribble(~first, ~last, ~instrument,
                    "Jimmy",   "Buffett",  "Guitar",    
                    "George", "Harrison ",  "Guitar",    
                    "Mick  ", "Jagger",  "Vocals",    
                    "Tom   ", "Jones",  "Vocals",    
                    "Davy  ", "Jones",  "Vocals",    
                    "John  ", "Lennon",  "Guitar",    
                    "Paul  ", "McCartney",  "Bass  ",    
                    "Jimmy ", "Page",  "Guitar",    
                    "Joe   ", "Perry",  "Guitar",    
                    "Elvis ", "Presley  ",  "Vocals",    
                    "Keith ", "Richards ",  "Guitar",    
                    "Paul  ", "Simon    ",  "Guitar",    
                    "Ringo ", "Starr    ",  "Drums ",    
                    "Joe   ", "Walsh    ",  "Guitar",    
                    "Brian ", "Wilson   ",  "Vocals",    
                    "Nancy ", "Wilson   ",  "Vocals") 

# removing whitespace
artists <- data.frame(lapply(artists, trimws), stringsAsFactors = FALSE)


# (c) create albums 
albums <- tribble(~album, ~band, ~year, 
                  "A Hard Day's Night       ",  "The Beatles       ",   1964,
                  "Magical Mystery Tour     ",  "The Beatles       ",   1967,
                  "Beggar's Banquet         ",  "The Rolling Stones",   1968,
                  "Abbey Road               ",  "The Beatles       ",   1969,
                  "Led Zeppelin IV          ",  "Led Zeppelin      ",   1971,
                  "The Dark Side of the Moon",  "Pink Floyd        ",   1973,
                  "Aerosmith                ",  "Aerosmith         ",   1973,
                  "Rumours                  ",  "Fleetwood Mac     ",   1977,
                  "Hotel California         ",  "Eagles            ",   1982) 

# remove whitespace
albums <- data.frame(lapply(albums, trimws), stringsAsFactors = FALSE)

# (d) Create "bands"
bands <- tribble(~first, ~last, ~band, 
                  "John     ",  "Bonham   ", "Led Zeppelin      ",
                  "John Paul",  "Jones    ", "Led Zeppelin      ",
                  "Jimmy    ",  "Page     ", "Led Zeppelin      ",
                  "Robert   ",  "Plant    ", "Led Zeppelin      ",
                  "George   ",  "Harrison ", "The Beatles       ",
                  "John     ",  "Lennon   ", "The Beatles       ",
                  "Paul     ",  "McCartney", "The Beatles       ",
                  "Ringo    ",  "Starr    ", "The Beatles       ",
                  "Jimmy    ",  "Buffett  ", "The Coral Reefers ",
                  "Mick     ",  "Jagger   ", "The Rolling Stones",
                  "Keith    ",  "Richards ", "The Rolling Stones",
                  "Charlie  ",  "Watts    ", "The Rolling Stones",
                  "Ronnie   ",  "Wood     ", "The Rolling Stones")

# remove whitespace
bands <- data.frame(lapply(bands, trimws), stringsAsFactors = FALSE)

```


## 1.1 Basic join
```{r}
bands %>%
  left_join(artists, by = c("first", "last"))


songs %>%
  inner_join(albums, by = "album")


artists %>%
  full_join(bands, by = c("first", "last"))
```


# 2. Filtering joins and set operations

## 2.1 Filtering joins 

* `semi_joint()`: A concise way to filter data from the first dataset based on information in a second dataset

* `anti_join()`: use an anti-join to see which rows will not be matched to a second dataset by a join

```{r}
# find artists with songs
artists %>%
  semi_join(songs, by = c("first", "last"))

albums %>% 
  # Collect the albums made by a band
  semi_join(bands, by = "band") %>% 
  # Count the albums made by a band
  nrow()

# Return rows of artists that don't have bands info
artists %>% 
  anti_join(bands, by = c("first", "last"))


```

## 2.2 Set operations

* `union()`: combine two datasets without duplicating any values. It will remove duplicate rows. 

* `intersect()`: very much like `semi_join()* if datasets contain the exact same variables

* `setdiff()`: 


## 2.3 Comparing datasets

* `setequal(x, y)` 



# 3. Assembling data

## 3.1 `bind_rows()`

```{r}
# list files inside a zip file 
master <- as.character(unzip("data/jimi_hendrix.zip", list = TRUE)$Name)

# read files from the zip files
discography <- read_csv(unz("data/jimi_hendrix.zip", master[2]))

jimi <- list(`Are You Experienced` = read_csv(unz("data/jimi_hendrix.zip",  master[3])), 
                 `Axis: Bold As Love` = read_csv(unz("data/jimi_hendrix.zip",  master[4])),
                 `Electric Ladyland` = read_csv(unz("data/jimi_hendrix.zip",  master[5])))
 
jimi %>% 
  # Bind jimi into a single data frame
  bind_rows(.id = "album") %>% 
  # Make a complete data frame
  left_join(discography, by = "album")
 
```

## 3.2 `bind_cols()`

```{r}
# list files inside a zip file 
master <- as.character(unzip("data/hank_williams.zip", list = TRUE)$Name)

# read files from the zip files without unzip
hank_charts <- read_csv(unzip("data/hank_williams.zip", master[1]))
hank_years <- read_csv(unzip("data/hank_williams.zip", master[2]))


# bind columns

hank_years %>% 
  # Reorder hank_years alphabetically by song title
  arrange(song) %>% 
  # Select just the year column
  select(year) %>% 
  # Bind the year column
  bind_cols(hank_charts) %>% 
  # Arrange the finished dataset
  arrange(year, song)
```

If two datasets whose rows do not align, it is meaningless data if we bind them together. 


## 3.3 data_frame(), as_data_frame()

```{r}
# create three vectors for the following excericises
hank_year <- hank_years$year
hank_song <- hank_years$song
hank_peak <- hank_charts$peak


# Make combined data frame using data_frame()
data_frame(year = hank_year, 
           song = hank_song, 
           peak = hank_peak ) %>% 
  # Extract songs where peak equals 1
  filter(peak == 1)
```



# 4. Advanced joining

# 5. Case study 